<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDWise WebSDK – Full HTML Demo (Start/Resume/Cleanup)</title>

  <!-- ✅ IDWise WebSDK (per docs) -->

  <link href="https://releases.idwise.com/websdk/latest/idwise.min.css" rel="stylesheet" />
  <script src="https://releases.idwise.com/websdk/latest/idwise.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7fb; }
    header { padding: 14px 18px; background: #111827; color: #fff; }
    header h1 { margin: 0; font-size: 15px; font-weight: 700; }
    main { padding: 18px; max-width: 980px; margin: 0 auto; }
    .card { background: #fff; border-radius: 14px; padding: 16px; box-shadow: 0 8px 22px rgba(0,0,0,.08); }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 820px) { .grid { grid-template-columns: 1fr; } }
    label { font-size: 12px; font-weight: 700; color: #374151; display: block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
    }
    textarea { min-height: 92px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .hint { font-size: 12px; color: #6b7280; line-height: 1.35; margin-top: 6px; }
    .btnrow { display:flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    button { padding: 10px 14px; border: 0; border-radius: 12px; font-weight: 800; cursor: pointer; }
    .primary { background:#2563eb; color:#fff; }
    .secondary { background:#e5e7eb; color:#111827; }
    .danger { background:#ef4444; color:#fff; }
    .mount {
      margin-top: 14px;
      min-height: 560px;
      border-radius: 14px;
      border: 1px dashed #cbd5e1;
      background: #fafafa;
      overflow: hidden;
    }
    .log {
      margin-top: 14px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      background: #0b1020;
      color: #c7d2fe;
      padding: 12px;
      border-radius: 14px;
      max-height: 260px;
      overflow: auto;
    }
    .pill {
      display:inline-block; padding: 4px 10px; border-radius: 999px;
      background:#111827; color:#fff; font-size: 12px; font-weight: 800;
    }
    .warn { color:#b45309; font-weight: 700; }
  </style>

</head>

<body>
  <header>
    <h1>IDWise WebSDK – Full Demo <span class="pill" id="sdkState">Not initialized</span></h1>
  </header>

  <main>
    <div class="card">
      <div class="grid">
        <div>
          <label for="clientKey">Client Key (Mandatory)</label>
          <input id="clientKey" placeholder="Paste your Client Key from IDWise Studio (API Keys → Client Key)" autocomplete="off" />
          <div class="hint">
            This is the <b>Client Key</b> used by WebSDK. It is provided/generated in IDWise Studio (Admin Portal → API Keys → Client Key).
          </div>
        </div>

```
    <div>
      <label for="locale">Locale + Theme</label>
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
          <select id="locale">
            <option value="en" selected>en</option>
            <option value="ar">ar</option>
          </select>
          <div class="hint">UI language (default: en).</div>
        </div>
        <div>
          <select id="theme">
            <option value="system_default" selected>system_default</option>
            <option value="light">light</option>
            <option value="dark">dark</option>
          </select>
          <div class="hint">UI theme.</div>
        </div>
      </div>
    </div>

    <div>
      <label for="flowSelect">Journey Flow ID (flowId) (Mandatory)</label>
      <select id="flowSelect">
        <option value="">Select a flow…</option>
        <!-- ✅ Replace the below with your FULL IDs (not truncated) -->
        <option value="cfbb44a9-dda2-4b29-be2f-xxxxxxxxxxxx">Other Documents</option>
        <option value="00e001f9-3ece-4fb0-88d1-xxxxxxxxxxxx">Passport</option>
        <option value="f69f47ff-4ca7-482b-93c7-xxxxxxxxxxxx">Passport &amp; EID</option>
        <option value="__custom__">Custom…</option>
      </select>
      <input id="flowCustom" placeholder="Paste custom Flow ID (UUID)" style="display:none; margin-top:10px;" autocomplete="off" />
      <div class="hint">
        Per docs, <b>flowId</b> is mandatory for startJourney/resumeJourney.
      </div>
    </div>

    <div>
      <label for="referenceNo">referenceNo (Optional but recommended)</label>
      <input id="referenceNo" placeholder="Your internal user id (e.g., customerId)" autocomplete="off" />
      <div class="hint">
        This links the journey to your system for later reconciliation.
      </div>
    </div>

    <div>
      <label for="journeyId">journeyId (Required only for Resume)</label>
      <input id="journeyId" placeholder="Paste existing journeyId to resume" autocomplete="off" />
      <div class="hint">
        You’ll get a journeyId from events like <b>onJourneyStarted</b>. Store it if you want resume support.
      </div>
    </div>

    <div>
      <label>Applicant Details (Optional)</label>
      <textarea id="applicantDetails" spellcheck="false">
```

{
"full_name": "John Doe",
"birth_date": "1995-05-06",
"sex": "male",
"address": "221 Sample Road, Placeholder House, Testford, London, T35 7AB, United Kingdom",
"nationality_code": "GBR"
} </textarea> <div class="hint">
Set to <b>null</b> if you don’t want to pass details. Supported keys per docs. </div> </div> </div>

```
  <div class="btnrow">
    <button class="primary" id="btnInit">1) Initialize</button>
    <button class="primary" id="btnStart">2) Start Journey</button>
    <button class="secondary" id="btnResume">Resume Journey</button>
    <button class="danger" id="btnCleanup">Cleanup (Cancel)</button>
    <button class="secondary" id="btnClearLog">Clear Log</button>
  </div>

  <div class="hint">
    <span class="warn">If initialize fails:</span> most common causes are invalid Client Key, wrong tenant/region, or running on an insecure origin.
    Host this on <b>https</b> (GitHub Pages / Netlify / Vercel) and open it from the hosted URL.
  </div>

  <!-- ✅ Mount point required by startJourney/resumeJourney -->
  <div id="idwise-mount" class="mount"></div>

  <div id="log" class="log">Log:\n</div>
</div>
```

  </main>

  <script>
    // -----------------------------
    // IDWise WebSDK demo - per docs:
    // IDWise.initialize({ clientKey, locale, theme }) -> Promise<session>
    // session.startJourney({ flowId, mount, applicantDetails, referenceNo, eventHandlers })
    // session.resumeJourney({ flowId, mount, journeyId, eventHandlers })
    // session.cleanup()
    // -----------------------------

    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const stateEl = $("sdkState");

    let idwise = null; // session instance returned by IDWise.initialize()

    function log(msg, obj) {
      const line = obj ? `${msg} ${safeJson(obj)}` : msg;
      logEl.textContent += line + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    function safeJson(x) {
      try { return JSON.stringify(x); } catch { return String(x); }
    }

    function getFlowId() {
      const v = $("flowSelect").value;
      if (v === "__custom__") return $("flowCustom").value.trim();
      return v.trim();
    }

    function getApplicantDetails() {
      const raw = $("applicantDetails").value.trim();
      if (!raw) return null;
      // allow user to type "null"
      if (raw === "null") return null;
      try { return JSON.parse(raw); }
      catch (e) {
        throw new Error("Applicant Details is not valid JSON. Either fix JSON or set it to null.");
      }
    }

    function setState(text) {
      stateEl.textContent = text;
    }

    // Toggle custom flow input
    $("flowSelect").addEventListener("change", () => {
      const isCustom = $("flowSelect").value === "__custom__";
      $("flowCustom").style.display = isCustom ? "block" : "none";
      if (!isCustom) $("flowCustom").value = "";
    });

    // Helpful pre-flight checks
    function preflightChecks() {
      if (!window.IDWise) {
        log("❌ IDWise SDK not found on window. Check script tag: https://releases.idwise.com/websdk/latest/idwise.min.js");
        return false;
      }
      return true;
    }

    // 1) Initialize (per docs)
    $("btnInit").addEventListener("click", async () => {
      if (!preflightChecks()) return;

      const clientKey = $("clientKey").value.trim();
      const locale = $("locale").value;
      const theme = $("theme").value;

      if (!clientKey) {
        alert("Client Key is required.");
        return;
      }

      try {
        log("Initializing IDWise…");
        setState("Initializing…");

        idwise = await IDWise.initialize({ clientKey, locale, theme });

        setState("Initialized ✅");
        log("✅ Initialized. Session ready.");
      } catch (err) {
        setState("Init failed ❌");
        log("❌ Initialize failed:", normalizeError(err));
        alert("Initialize failed. Check the log for details.");
      }
    });

    // 2) Start Journey (per docs)
    $("btnStart").addEventListener("click", async () => {
      if (!preflightChecks()) return;

      const flowId = getFlowId();
      const referenceNo = $("referenceNo").value.trim() || undefined;

      if (!flowId) {
        alert("flowId is required (select a Journey Flow).");
        return;
      }

      try {
        if (!idwise) {
          alert("Please click Initialize first.");
          return;
        }

        // Per docs: cleanup before starting a new journey within same page/session
        log("Calling cleanup() before starting a new journey (recommended)...");
        try { await idwise.cleanup(); } catch { /* ignore */ }

        const applicantDetails = getApplicantDetails();

        log("Starting journey…");
        setState("Journey running…");

        idwise.startJourney({
          flowId,
          mount: "#idwise-mount",
          applicantDetails,
          referenceNo,
          eventHandlers: {
            onJourneyStarted: (details) => {
              log("✅ onJourneyStarted:", details);
              // Tip: store details.journeyId to DB if you want resume support
              if (details?.journeyId) $("journeyId").value = details.journeyId;
            },
            onJourneyFinished: (details) => {
              log("✅ onJourneyFinished:", details);
              setState("Initialized ✅ (journey finished)");
            },
            onJourneyCancelled: (details) => {
              log("⚠️ onJourneyCancelled:", details);
              setState("Initialized ✅ (journey cancelled)");
            },
            onError: (details) => {
              log("❌ onError:", details);
              setState("Initialized ✅ (error)");
            }
          }
        });

      } catch (err) {
        log("❌ startJourney exception:", normalizeError(err));
        alert("Start Journey failed. Check the log for details.");
      }
    });

    // Resume Journey (per docs)
    $("btnResume").addEventListener("click", async () => {
      if (!preflightChecks()) return;

      const flowId = getFlowId();
      const journeyId = $("journeyId").value.trim();

      if (!flowId) {
        alert("flowId is required (select a Journey Flow).");
        return;
      }
      if (!journeyId) {
        alert("journeyId is required to resume.");
        return;
      }

      try {
        if (!idwise) {
          alert("Please click Initialize first.");
          return;
        }

        log("Calling cleanup() before resuming (recommended)...");
        try { await idwise.cleanup(); } catch { /* ignore */ }

        log("Resuming journey…");
        setState("Journey running…");

        idwise.resumeJourney({
          flowId,
          mount: "#idwise-mount",
          journeyId,
          eventHandlers: {
            onJourneyResumed: (details) => {
              log("✅ onJourneyResumed:", details);
            },
            onJourneyFinished: (details) => {
              log("✅ onJourneyFinished:", details);
              setState("Initialized ✅ (journey finished)");
            },
            onJourneyCancelled: (details) => {
              log("⚠️ onJourneyCancelled:", details);
              setState("Initialized ✅ (journey cancelled)");
            },
            onError: (details) => {
              log("❌ onError:", details);
              setState("Initialized ✅ (error)");
            }
          }
        });

      } catch (err) {
        log("❌ resumeJourney exception:", normalizeError(err));
        alert("Resume Journey failed. Check the log for details.");
      }
    });

    // Cleanup (Cancel) per docs
    $("btnCleanup").addEventListener("click", async () => {
      try {
        if (!idwise) {
          log("cleanup(): session not initialized yet.");
          return;
        }
        log("Calling cleanup()…");
        await idwise.cleanup();
        log("✅ cleanup() completed. UI removed / journey cancelled.");
        setState("Initialized ✅ (clean)");
      } catch (err) {
        log("❌ cleanup() failed:", normalizeError(err));
      }
    });

    $("btnClearLog").addEventListener("click", () => {
      logEl.textContent = "Log:\n";
    });

    function normalizeError(err) {
      // IDWise docs show errors can be objects with code/message/requestId
      if (!err) return { message: "Unknown error (empty)" };
      if (typeof err === "string") return { message: err };
      return {
        code: err.code,
        message: err.message || String(err),
        requestId: err.requestId,
        raw: err
      };
    }

    // Auto-log environment
    window.addEventListener("load", () => {
      log("Page loaded.");
      log("SDK present:", { IDWise: !!window.IDWise });
      log("Origin:", { origin: window.location.origin, protocol: window.location.protocol });
      if (window.location.protocol !== "https:" && window.location.hostname !== "localhost") {
        log("⚠️ Not running on HTTPS. Some browsers/features may block camera access.", { protocol: window.location.protocol });
      }
    });
  </script>

</body>
</html>
